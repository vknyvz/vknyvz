name: Deploy vknyvz

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy vknyvz.com
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.LIGHTSAIL_HOST }}
        username: ${{ secrets.LIGHTSAIL_USER }}
        key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
        script: |
          cd /home/ec2-user/vkn-mainframe
          git pull origin main
          
          cd /home/ec2-user/apps/vknyvz
          git pull origin main
          
          echo "=== Checking if watch-api folder exists on host ==="
          ls -la vknyvz-web/src/app/
          ls -la vknyvz-web/src/app/watch-api/ || echo "watch-api folder not found"
          
          cd /home/ec2-user/vkn-mainframe
          
          docker-compose -f docker-compose.multi.yml --profile vknyvz down
          docker container prune -f
          docker builder prune -a -f
          
          echo "=== Removing vknyvz-web image completely ==="
          docker rmi vkn-mainframe_vknyvz-web || echo "Image not found"
          
          docker-compose -f docker-compose.multi.yml --profile vknyvz build --no-cache vknyvz-web vknyvz-api
          docker-compose -f docker-compose.multi.yml --profile vknyvz up -d vknyvz-web vknyvz-api
          
          echo "=== Checking if watch-api folder exists in container ==="
          docker exec vknyvz-web ls -la /app/src/app/ || echo "Failed to list container contents"
          
          docker system prune -f